<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ECS521 Project: Escape Game</title>
<style>
body{
	background-color:black;
	margin : 0;
	display: block;
}
#game{
}
#canvasOne{
	overflow:hidden;
	display: block;
	margin: 0;
}
#canvasTwo{
	background-color:white;
	margin:0;
}
</style>
</head>
<body>
    <canvas id = "canvasOne" width = "1000" height = "700"></canvas>

<script type="text/javascript" src="Events.js"></script>
<script type="text/javascript" src ="Animation.js"></script>
<script type="text/javascript" src ="audio.js"></script>
<script type="text/javascript">

    /**
     * Screen 0: start screen
     * 1: basic living room view
     * 2: up close puzzle view
     * 3: up close portrait painting view
     * 4: up close desk drawer view
     * 5: up close xylophone view
     * 6: hallway view
     * 7: up close bedroom door
     * 8: winning screen
     * 9: death by monster screen
     * 10: death by timer screen
     */
	var maxMinutes = 5;
    var currentScreen = 0;
	var totalResources = 52;
	var numResourcesLoaded = 0;
	var finishedLoading = false;
	var images = {};
	var hasBedroomKey = false; // until they get it from the portrait
    var hasWeapon = false; // until they get the fire poker
    var hasStick = false; // until they get the stick from the lampshade
	var hasDrawerKey = false;
	var hasMainKey = false; //key to front door
	var portraitOpen = false;
	var portraitOpening = false;//check if portrait is opening
	var drawerOpen = false;
	var drawerOpening = false;//check if drawer is opening
	var xylophoneOpen = false;
	var xylophoneOpening = false;
	var bedroomOpen = false;
	var bedroomOpening = false;//check if bedroom is opening
	var bedroomOpening2 = false;//check if bedroom opening animation is at its second stage
	var monsterAlive = true;
	var safeOpen = false; //check if safe is open
	var lampOn = true;
	var puzzleComplete = false;
	var puzx = [488, 541, 337, 337, 250, 445, 225, 393, 193];
	var puzy = [495, 401, 306, 402, 255, 409, 443, 495, 345];
	var fireCount = 1;
	var dragging = null;
	//global events
	var events;
	//array to hold the different screens
	var screens = [];
	//array to draw events for different screens
	var drawEvents = [];
	//time for animations
	var d = Date.now();
	//timer object
	var timer = new Timer();


	//messages
	var message = new Message;
	var toolbox = false; //condition to draw toolbox
	//bing sound
	var bing = AudioFX('audio/BLING',   { formats: ['wav'], pool: 100 });
	//death sound
	var death = AudioFX('audio/death',   { formats: ['wav'], pool: 100 });
	//monster death sound
	var monsterdeath = AudioFX('audio/monsterdeath',   { formats: ['wav'], pool: 100 });
	//open shuffle sound
	var openShuffle = AudioFX('audio/openshuffle',   { formats: ['wav'], pool: 100 });
	//open door sound
	var openDoor = AudioFX('audio/opendoor',   { formats: ['wav'], pool: 100 });
	//close door sound
	var closeDoor = AudioFX('audio/closedoor',   { formats: ['wav'], pool: 100 });
	//lamp switch sound
	var lampSwitch = AudioFX('audio/switch',   { formats: ['wav'], pool: 100 });
    // wrong passcode sound
    var wrongPass = AudioFX('audio/errorSound', {formats: ['m4a'], pool: 100});
    // locked door sound
    var lockedSound = AudioFX('audio/stillLockedSound', {formats: ['m4a'], pool: 100});


	//xylophone stick coordinates
		var stickX = -500;
		var stickY = 0;

	//drawer key coordinates
	var puzzleKeyY = 290;
	var puzzleKeyX = 500;


    // xylophone notes
    var noteRow = [];

	//create xylophone puzzle notes
	var noteLetters = ["C","D","E","F","G","A","B"];
	var xylophoneAnswer = [];
	var numNotes = 6;            //number of notes user has to input
	var inputNotes = [numNotes];
	var noteString = "";
	for(i = 0 ; i<numNotes;i++){
		xylophoneAnswer[i] = random(0,6);

		if(i==0){
			noteString = noteString +  noteLetters[xylophoneAnswer[i]];
		}
		else{
			noteString = noteString +", " +  noteLetters[xylophoneAnswer[i]];
		}
	}
	console.log(noteString);

	//portrait code
	var portraitCode = [4];
	var portraitInput = [0,0,0,0];
	var safeString = "";

	for(i=0;i<4;i++){
		portraitCode[i] = random(0,9);
		safeString = " " + safeString + portraitCode[i];
		if(i!=3){
			safeString = safeString + ",";
		}
	}
	console.log(safeString);


	// Returns a random integer between min (included) and max (included)
	function random(min, max) {
	  min = Math.ceil(min);
	  max = Math.floor(max);
	  return Math.floor(Math.random() * (max - min + 1)) + min;
	}
	function newNote(note){
		//input new note into array and check if all notes are equal

		var equal = 0;
		var i = 0;

		for(i=0;i<numNotes-1;i++){
			inputNotes[i] = inputNotes[i+1];
			if(inputNotes[i]==xylophoneAnswer[i]){equal++;}
		}

		inputNotes[i] = note;
		if(inputNotes[i]==xylophoneAnswer[i]){

			equal++;
			if(equal==6){
				//puzzle is solved
				message.displayMess("You pressed the right keys!");
				//play xlophone opening sound
				openShuffle.play();
				xylophoneOpening = true;
				setTimeout(function(){
					xylophoneOpening = false;
					xylophoneOpen = true;
				}, 500);
				safeOpen = false;

			}

		}



	}
	function newInputPortrait(up,num){
		//change array of input of portrait

		if(up){
			if(portraitInput[num]<9){
				portraitInput[num]++;
			}
			else{
				portraitInput[num]=0;
			}
		}
		else{
			if(portraitInput[num]>0){
				portraitInput[num]--;
			}
			else{
				portraitInput[num]=9;
			}
		}





	}
	function changeScreen(screen){
		currentScreen = screen;
	}
	function loadImage(name) {
		//add image to images array and check if loaded
		images[name] = new Image();
		images[name].onload = function() {
			resourceLoaded();
		}
		images[name].src = "./images/" + name + ".png";
	}
	function resourceLoaded() {
		//check if all images are loaded
		numResourcesLoaded += 1;
		if(numResourcesLoaded === totalResources) {
			game();
		}
	}
    function init() {
        var canvas = document.getElementById('canvasOne');
        var context = canvas.getContext('2d');

		//loading prompt for user
		context.fillStyle="white";
		context.font = "100px Georgia";
		context.fillText("loading...", 40, 140);

		//load images
		loadImage("SCREEN1");
		loadImage("SCREENGAMEOVER");
		loadImage("SCREENMONSTER");
		loadImage("SCREENWIN");
		loadImage("opendoor");
		loadImage("monster");
		loadImage("final");
		loadImage("hallway");
		loadImage("deathdoor");
		loadImage("fire1");
		loadImage("fire2");
		loadImage("fire3");
		loadImage("fire3dark");
		loadImage("fire2dark");
		loadImage("fire1dark");
		loadImage("xylophone");
		loadImage("table");
		loadImage("keyfrompuzzle");
		loadImage("puzzleboxwpieces");
		loadImage("puzzleboxwpiecesdark");
		loadImage("puzzleboxwpiecescomplete");
		loadImage("puzzleboxwpiecescompletedark");
		loadImage("puzzleopened");
		loadImage("halfopened");
		loadImage("openedsafe");
		loadImage("openportrait");
		loadImage("portraitclose");
		loadImage("key2");
		loadImage("poker");
		loadImage("drawerclosed");
		loadImage("drawerhalfopened");
		loadImage("draweropened");
		loadImage("deathdoorangled");
		loadImage("deathdoorangled2");
		loadImage("deathdoorangled2withmonster");
		loadImage("monster");
		loadImage("opendoor");
		loadImage("SCREENMONSTER");
		loadImage("inthedark2up");
        loadImage("inthedarkup");
		loadImage("xylophonefull");
		loadImage("xylophonehalf");
		loadImage("redkey");

		//load puzzlepieces
		for(i=0;i<9;i++){
			loadImage(i);
		}




        // fill in each note of the close-up xylophone
        noteRow[0] = new Note(0,"cNote", 17, 334, 175,
            688, context);
        noteRow[1] = new Note(1,"dNote", 184, 359, 332,
            683, context);
        noteRow[2] = new Note(2,"eNote", 336, 371, 472,
            673, context);
        noteRow[3] = new Note(3,"fNote", 473, 381, 607,
            673, context);
        noteRow[4] = new Note(4,"gNote", 615, 390, 742,
            673, context);
        noteRow[5] = new Note(5,"aNote", 746, 397, 868,
            665, context);
        noteRow[6] = new Note(6,"bNote", 873, 405, 989,
            665, context);



    }
	function createEventBox(x,y,width,height,screen){
		createEventShape(
		x,
		y,
		x+width,
		y,
		x+width,
		y+height,
		x,
		y+height,
		screen);
	}
	function createEventShape(x,y,x1,y1,x2,y2,x3,y3,screen){

			events.beginRegion();
			events.context.beginPath();
//			events.context.fillStyle = "#00D2FF";// comment to avoid flicker
			events.context.moveTo(x,y);
			events.context.lineTo(x1,y1);
			events.context.lineTo(x2,y2);
			events.context.lineTo(x3,y3);
//			events.context.fill();       // comment to avoid flicker
			events.context.closePath();
			events.addRegionEventListener("mousedown",function(){
				dragging = null;
				changeScreen(screen);
			});
			events.addRegionEventListener("mousemove", function () {
					document.body.style.cursor = "pointer";
			});

			events.closeRegion();

	}

	// transition arrows to get out of close up views of objects
	function eventArrow(x, y, screen) {
        events.context.fillStyle = "#00D2FF";
        events.beginRegion();
        events.context.beginPath();
        events.context.moveTo(x, y);
        events.context.lineTo(x + 40, y);
        events.context.lineTo(x + 40, y + 13);
        events.context.lineTo(x + 58, y - 8);
        events.context.lineTo(x + 40, y - 25);
        events.context.lineTo(x + 40, y - 13);
        events.context.lineTo(x, y - 13);
        events.context.lineTo(x, y);
        events.context.fill();
        events.context.closePath();
        events.addRegionEventListener("mousedown", function() {
            changeScreen(screen);
        });
        events.addRegionEventListener("mousemove", function () {
            document.body.style.cursor = "pointer";
        });
        events.closeRegion();

    }
	function getItemEvent(x,y,width,height,toDo){

			events.beginRegion();
			events.context.beginPath();
//			events.context.fillStyle = "#00D2FF";
//			events.context.strokeStyle="#000000";
			//events.context.lineWidth=5;
			events.context.rect(x,y,width,height);
//			events.context.fill();
			//events.context.stroke();
			events.context.closePath();
			events.addRegionEventListener("mousedown",function(){
				toDo();
				dragging = null;
			});
			events.addRegionEventListener("mousemove", function () {
					document.body.style.cursor = "pointer";
			});

			events.closeRegion();

	}
	function dragEvent(x,y,width,height,toDo){

			events.beginRegion();
			events.context.beginPath();
			//events.context.fillStyle = "#00D2FF";
			events.context.rect(x,y,width,height);
			//events.context.fill();
			events.context.closePath();
			events.addRegionEventListener("mousedown",function(){
				toDo();
			});
			events.addRegionEventListener("mousemove", function () {
					document.body.style.cursor = "pointer";
			});

			events.closeRegion();

	}
	function drawSafe(){

		var x = 570;
		var y = 320;
		for(i=0;i<4;i++){
			//draw triangles
			events.context.beginPath();
			events.context.lineWidth = 4;
			events.context.strokeStyle = "black";
			events.context.fillStyle = "#FFFB00";
			events.context.moveTo(x+25,y-145);
			events.context.lineTo(x+50,y-95);
			events.context.lineTo(x,y-95);
			events.context.closePath();
			events.context.fill();
			events.context.stroke();

			events.context.beginPath();
			events.context.lineWidth = 4;
			events.context.strokeStyle = "black";
			events.context.fillStyle = "#FFFB00";
			events.context.moveTo(x,y+55);
			events.context.lineTo(x+50,y+55);
			events.context.lineTo(x+25,y+105);
			events.context.closePath();
			events.context.fill();
			events.context.stroke();

			//draw number
			events.context.save();
			events.context.font = '60pt Georgia';
			events.context.fillStyle= "black";
			events.context.fillText(portraitInput[i], x, y);
			events.context.restore();
			x = x + 101;
		}

	}
	function toggledoor(){
		if(hasBedroomKey){

			//animate bedroom door
			if(bedroomOpen){
				//animate bedroom closing
				bedroomOpening2 = true;

				setTimeout(function(){
					bedroomOpening = true;
					bedroomOpening2 = false;

					setTimeout(function(){
						closeDoor.play();
						bedroomOpening = false;
						bedroomOpen = false;
					}, 500);
				}, 500);
			}
			else{

				if(dragging =="bedroomkey"){
					dragging = null;
					//animate bedroom opening
					bedroomOpening = true;
					bedroomOpen = !bedroomOpen;


					setTimeout(function(){
						bedroomOpening = false;
						bedroomOpening2 = true;
						openDoor.play();

						setTimeout(function(){
							bedroomOpening2 = false;
							bedroomOpen = true;


							if(monsterAlive){
								if(hasWeapon){
									message.displayMess("Killed monster with weapon!");
									//play monster dying sound
									monsterdeath.play();
									//kill monster
									setTimeout(function(){
										monsterAlive = false;
									}, 1500);

								}
								else{
									//play dying sound
									death.play();
									//change screen
									setTimeout(function(){
										changeScreen(9);
									}, 1500);
								}
							}

						}, 500);
					}, 500);


				}
				else{
                    lockedSound.play();
					message.displayMess("You need a key");
				}




			}
		}
		else{
            lockedSound.play();
			message.displayMess("You need a key");
		}

	}
	function drawStick(cursorX,cursorY) {

		events.context.beginPath();
		events.context.arc(cursorX, cursorY, 30, 0, 2 * Math.PI, true);
		events.context.fillStyle = "#FF6A6A";
		events.context.strokeStyle = "#FF6A6A";
		events.context.lineWidth = 7;
		events.context.closePath();
		events.context.fill();

		events.context.beginPath();
		events.context.moveTo(cursorX + 15, cursorY + 15);
		events.context.lineTo(cursorX + 130, cursorY + 130);
		events.context.stroke();
		events.context.closePath();
	}
    function Timer(){
		this.minutes = maxMinutes;
		this.seconds = 0;
		this.m = Date.now();
		this.s = Date.now();
		this.time = Date.now();
		this.separation = 40;  //separation between seconds and minutes

		this.moreTime = function(){
			this.time = Date.now();
		}

		this.drawMinutes = function(x,y){

			var text = "";
			if (this.minutes<10){
				text = "0"+this.minutes;
			}
			else{
				text = this.minutes;
			}

			events.context.save();
			events.context.font = '20pt Georgia';
			events.context.lineWidth = 2;
			events.context.strokeStyle = "white";
			events.context.fillStyle= "white";
			events.context.fillText(text, x,y);
			events.context.strokeText(text, x,y);
			events.context.restore();
		};

		this.drawSeconds = function(x,y){

			if(this.s+1000 <= this.time){
				this.s = Date.now();
				this.seconds--;
				if(this.seconds<0){
					this.seconds = 59;
					this.minutes--;
				}
				if(this.minutes == 0 && this.seconds==0){
					changeScreen(10);
				}
			}


			var text = "";
			if (this.seconds<10){
				text = "0"+this.seconds;
			}
			else{
				text = this.seconds;
			}

			events.context.save();
			events.context.font = '20pt Georgia';
			events.context.lineWidth = 2;
			events.context.strokeStyle = "white";
			events.context.fillStyle= "white";
			events.context.fillText(": " + text, x,y);
			events.context.strokeText(": " + text, x,y);
			events.context.restore();

		};

		this.drawTime = function(x,y){
			this.moreTime();
			this.drawSeconds(x+this.separation,y);
			this.drawMinutes(x,y);
		};
		this.getTimeString = function(x,y){
			var secs = "";
			if (this.seconds<10){
				secs = "0"+this.seconds;
			}
			else{
				secs = this.seconds;
			}

			var mins = "";

			if (this.minutes<10){
				mins = "0"+this.minutes;
			}
			else{
				mins = this.minutes;
			}

			return mins+" : "+secs;


		};
	}
	function restartGame(){
		//restart timer
		timer.minutes = maxMinutes;
		timer.seconds = 0;
		dragging = null;
		currentScreen = 1;
		hasBedroomKey = false; // until they get it from the portrait
		hasWeapon = false; // until they get the fire poker
		hasStick = false; // until they get the stick from the lampshade
		hasDrawerKey = false;
		hasMainKey = false; //key to front door
		portraitOpen = false;
		portraitOpening = false;//check if portrait is opening
		drawerOpen = false;
		drawerOpening = false;//check if drawer is opening
		xylophoneOpen = false;
		xylophoneOpening = false;
		bedroomOpen = false;
		bedroomOpening = false;//check if bedroom is opening
		bedroomOpening2 = false;//check if bedroom opening animation is at its second stage
		monsterAlive = true;
		safeOpen = false; //check if safe is open
		lampOn = true;
		puzzleComplete = false;
		puzx = [488, 541, 337, 337, 250, 445, 225, 393, 193];
		puzy = [495, 401, 306, 402, 255, 409, 443, 495, 345];
		fireCount = 1;
		toolbox = false; //condition to draw toolbox
		stickX = -500;
		stickY = 0;
		//drawer key coordinates
		puzzleKeyY = 290;
		puzzleKeyX = 500;
		noteString = "";
		for(i = 0 ; i<numNotes;i++){
			xylophoneAnswer[i] = random(0,6);

			if(i==0){
				noteString = noteString +  noteLetters[xylophoneAnswer[i]];
			}
			else{
				noteString = noteString +", " +  noteLetters[xylophoneAnswer[i]];
			}
		}
		portraitInput = [0,0,0,0];
		safeString = "";

		for(i=0;i<4;i++){
			portraitCode[i] = random(0,9);
			safeString = " " + safeString + portraitCode[i];
			if(i!=3){
				safeString = safeString + ",";
			}
		}

	}
	// defining each note on the xylophone
    function Note(num, note, topLeftX, topLeftY, topRightX, bottomLeftY, context) {
        this.ctx = context;

        this.note = note;
		this.noteNum = num;
		this.noteAudio = AudioFX('audio/'+note,   { formats: ['wav'], pool: 100 });
		this.alpha = 0.0;

        //x and y coordinates of the outline of the key
        this.topLeftX = topLeftX;
        this.topLeftY = topLeftY;
        this.topRightX = topRightX;
        this.bottomLeftY = bottomLeftY;

        this.width = topRightX - topLeftX;
        this.height = bottomLeftY - topLeftY;
		this.drawBox = function(){

			this.alpha = this.alpha - .01;
			if(this.alpha>0){
				ctx = events.context;
				ctx.save();
				ctx.beginPath();
				ctx.rect(this.topLeftX, this.topLeftY, this.width, this.height);
				ctx.fillStyle = "rgba(255, 0, 0, " + this.alpha + ")";
				ctx.fill();
				ctx.closePath();
				ctx.restore();
			}
			else{
				this.alpha = 0.0;
			}
		};
    }
    Note.prototype.playSelf = function() {
		this.alpha = 1.0;
		this.noteAudio.play();
		//update and check note input array
      	newNote(this.noteNum);
    };
    Note.prototype.keyDidPlay = function() {
        if (stickX >= this.topLeftX && stickX <= this.topRightX
            && stickY >= this.topLeftY && stickY <= this.bottomLeftY) {
            return true;
        } else {
            return false;
        }
    };
	function Message(){
		this.text= "";
		this.alpha = 0.0;
		this.displayMess = function(string){
			this.text = string;
			this.alpha = 1.0
		};
		this.drawMessage = function(){

			if(this.alpha>0){
				//draw message
				events.context.save();
				events.context.font = '60pt Georgia';
				events.context.lineWidth = 3;
				events.context.strokeStyle = "rgba(0, 0, 0, " + this.alpha + ")";
				events.context.fillStyle= "rgba(255, 255, 255, " + this.alpha + ")";
				events.context.fillText(this.text, 0, 680);
				events.context.strokeText(this.text, 0, 680);
				events.context.restore();

				this.alpha = this.alpha - 0.01;
			}


		};

	}

	function createScreens(){
		//for puzzle
		var draggingRect = [false,false,false,false,false,false,false,false,false];
		var check = 0;
		var draggingRectOffsetX = [0,0,0,0,0,0,0,0,0];
		var draggingRectOffsetY = [0,0,0,0,0,0,0,0,0];
		var piecewidth = 69;
		var context = events.context;
		var pixlet = 10;         //how many pixels we can be not correctly placed


		screens = [
			//main menu draw
			function(){
				events.context.drawImage(images["SCREEN1"], 0, 0, events.canvas.width, events.canvas.height);
			},
			//living room draw
			function(){
				time = Date.now();
				var firestring ;

				if(lampOn){
					firestring = "fire"+fireCount;
					events.context.drawImage(images["final"], 0, 0, events.canvas.width, events.canvas.height);
					if(puzzleComplete){
						events.context.drawImage(images["puzzleboxwpiecescomplete"], 440, 370, 120, 120);
					}
					else{
						events.context.drawImage(images["puzzleboxwpieces"], 440, 370, 120, 120);
					}
				}
				else {
					firestring = "fire"+fireCount+"dark";
					if (hasStick) {
						events.context.drawImage(images["inthedarkup"], 0, 0, events.canvas.width, events.canvas.height);
					}
					else{
						events.context.drawImage(images["inthedark2up"], 0, 0, events.canvas.width, events.canvas.height);
					}
					if(puzzleComplete){
						events.context.drawImage(images["puzzleboxwpiecescompletedark"], 440, 370, 120, 120);
					}
					else{
						events.context.drawImage(images["puzzleboxwpiecesdark"], 440, 370, 120, 120);
					}
				}


				if(!hasWeapon){
					events.context.drawImage(images["poker"], 317, 170, 120, 120);
				}

				//draw light switch?

				events.context.drawImage(images[firestring], 170, 170, 200, 200);
				if(time>d+100){
					fireCount++;
					d = Date.now();
				}
				if(fireCount==4){
					fireCount=1;
				}
			},
			//puzzle draw
			function(){
				var i ;
				events.context.drawImage(images["table"], 0, 0, events.canvas.width, events.canvas.height);

				//draw small box
				events.context.beginPath();
				events.context.strokeStyle="#000000";
				events.context.lineWidth=5;
				events.context.fillStyle = "#B47524";
				events.context.rect(puzzleKeyX,puzzleKeyY,100,100);
				events.context.fill();
				events.context.stroke();
				events.context.closePath();

				//draw key
				if(!hasDrawerKey){
					events.context.drawImage(images["keyfrompuzzle"], puzzleKeyX, puzzleKeyY, 100,100);
					//events.context.drawImage(images["redkey"], puzzleKeyX-5, puzzleKeyY, 100,100);
				}

				events.context.drawImage(images["puzzleopened"], 400, 90, 312, 312);
				for(i=0;i<9;i++){
					events.context.drawImage(images[i], puzx[i], puzy[i], piecewidth, piecewidth);
				}

			},
			//Portrait draw
			function(){
				if(portraitOpening){
					events.context.drawImage(images["halfopened"], 0, 0, events.canvas.width, events.canvas.height);
					drawSafe();
				}
				else if(safeOpen){
					events.context.drawImage(images["openedsafe"], 0, 0, events.canvas.width, events.canvas.height);
					if(!hasBedroomKey){
						events.context.drawImage(images["key2"], 650, 220, 200, 200);
					}

				}
				else if(portraitOpen){
					events.context.drawImage(images["openportrait"], 0, 0, events.canvas.width, events.canvas.height);
					drawSafe();
				}
				else{
					events.context.drawImage(images["portraitclose"], 0, 0, events.canvas.width, events.canvas.height);
				}

			},
			//Drawer draw
			function(){
				if (drawerOpening) {
						events.context.drawImage(images["drawerhalfopened"], 0, 0, events.canvas.width, events.canvas.height);
				}
				else if(!drawerOpen){
					events.context.drawImage(images["drawerclosed"], 0, 0, events.canvas.width, events.canvas.height);
				}
				else {
						events.context.drawImage(images["draweropened"], 0, 0, events.canvas.width, events.canvas.height);
						events.context.font = "30px Arial";
						events.context.fillStyle = "#000000";
						events.context.fillText(noteString, 400, 550);

				}
			},
			//xylophone draw
			function(){
				if (xylophoneOpening){
					events.context.drawImage(images["xylophonehalf"], 0, 0, events.canvas.width, events.canvas.height);
				}
				else{
					if(xylophoneOpen){
						events.context.drawImage(images["xylophonefull"], 0, 0, events.canvas.width, events.canvas.height);
						events.context.font = "60px Arial";
						events.context.fillStyle = "#000000";
						events.context.fillText(safeString, 300, 250);
					}
					else{
						events.context.drawImage(images["xylophone"], 0, 0, events.canvas.width, events.canvas.height);
					}

				}


				var i ;

				for(i=0;i<7;i++){
					noteRow[i].drawBox();
				}

				//draw stick
				if(hasStick){
					drawStick(stickX,stickY);
				}


			},
			//hallway Draw
			function(){
				events.context.drawImage(images["hallway"], 0, 0, events.canvas.width, events.canvas.height);

			},
			//bedroom draw
			function(){
				if(bedroomOpening){
					events.context.drawImage(images["deathdoorangled"], 0, 0, events.canvas.width, events.canvas.height);
				}
				else if(bedroomOpening2){
					if(monsterAlive){
						events.context.drawImage(images["deathdoorangled2withmonster"], 0, 0, events.canvas.width, events.canvas.height);
					}
					else{
						events.context.drawImage(images["deathdoorangled2"], 0, 0, events.canvas.width, events.canvas.height);
					}
					if(!hasMainKey){
							events.context.drawImage(images["redkey"], 460, 400, 100,100);
						}

				}
				else{
					if(bedroomOpen){
						if(monsterAlive){
							events.context.drawImage(images["monster"], 0, 0, events.canvas.width, events.canvas.height);
						}
						else{
							events.context.drawImage(images["opendoor"], 0, 0, events.canvas.width, events.canvas.height);
						}
						if(!hasMainKey){
							events.context.drawImage(images["redkey"], 460, 400, 100,100);
						}
					}
					else{
						events.context.drawImage(images["deathdoor"], 0, 0, events.canvas.width, events.canvas.height);
					}

				}

			},
			//win screen draw
			function(){
				events.context.drawImage(images["SCREENWIN"], 0, 0, events.canvas.width, events.canvas.height);
				//draw time
				var text = timer.getTimeString() + " Remaining";

				events.context.save();
				events.context.font = '60pt Georgia';
				events.context.lineWidth = 3;
				events.context.strokeStyle = "black";
				events.context.fillStyle= "white";
				events.context.fillText(text, 100,500);
				events.context.strokeText(text, 100,500);
				events.context.restore();
			},
			//death by monster draw
			function(){
				events.context.drawImage(images["SCREENMONSTER"], 0, 0, events.canvas.width, events.canvas.height);
			},
			//death by timer
			function(){
				events.context.drawImage(images["SCREENGAMEOVER"], 0, 0, events.canvas.width, events.canvas.height);
			}
		];

		drawEvents = [
			//main menu events
			function(){
				createEventBox(270,430,460,222,1);
			},
			//living room events
			function(){
				createEventBox(500,32,67,75,3);
				createEventBox(510, 150, 130, 20, 4);
//				createEventBox(0,0,100,50,0); //debugging region
				createEventShape(880,0,1000,0,1000,360,880,260,6);
				createEventShape(7,520,229,385,265,416,77,590,5);
				createEventBox(400,380,220,120,2);

				dragEvent(683,10,136,222,function(){

					if(dragging=="mainkey"){
						openDoor.play();
						dragging=null;
						currentScreen = 8;
					}
					else{
                        lockedSound.play();
						message.displayMess("You need a key");
					}

				});

				getItemEvent(387,24,61,66,function(){

					if(!lampOn && !hasStick){
						var stickX = 415;
						var stickY = 40;
						var stickW = 10;
						var stickH = 40;

						getItemEvent(stickX,stickY,stickW,stickH,function(){
						    bing.play();
							message.displayMess("You found a xylophone stick");
							hasStick = true;
							lampOn = !lampOn;
						});
						lampOn = !lampOn;
						if(!hasStick){
							lampSwitch.play();
						}
					}
					else {
						lampOn = !lampOn;
						lampSwitch.play();
					}

				});



				if(!hasWeapon){
					getItemEvent( 350, 170, 30, 120,function(){
						hasWeapon = true;
                        bing.play();
						message.displayMess("You found a weapon!");
					});
				}
			},
			//puzzle events
			function(){
                eventArrow(900, 630, 1);
				//event to get key
				if(puzzleComplete&&!hasDrawerKey){
					getItemEvent(puzzleKeyX, puzzleKeyY, 100,100,function(){
						hasDrawerKey = true;
                        bing.play();
						message.displayMess("You found a key!");
					});
				}


				//now manage the pieces
				for(i=0;i<9;i++){
					if (draggingRect[i]) {
						var mousePos = events.getMousePos();
						puzx[i] = mousePos.x - draggingRectOffsetX[i];
						puzy[i] = mousePos.y - draggingRectOffsetY[i];
					}

					events.beginRegion();
					events.context.rect(puzx[i], puzy[i], piecewidth,piecewidth);
					events.addRegionEventListener("mousedown", function(){

						var mousePos = events.getMousePos();
						if( mousePos.x - puzx[i]< piecewidth &&  mousePos.x - puzx[i]>0){
							draggingRect[i] = true;
							draggingRectOffsetX[i] = mousePos.x - puzx[i];
							draggingRectOffsetY[i] = mousePos.y - puzy[i];
						}
					});
					events.addRegionEventListener("mouseup", function(){

						draggingRect[i] = false;
						if(!puzzleComplete){
							//now check if pieces are organized
							for(i=0;i<9;i++){
								draggingRect[i] = false;
								if(i==2||i==5){
									if((puzx[i]-(piecewidth*2)>puzx[i+1]-pixlet)&&(puzx[i]-(piecewidth*2)<puzx[i+1]+pixlet)){

										if((puzy[i] + piecewidth > puzy[i+1]-pixlet)&&(puzy[i] + piecewidth < puzy[i+1]+pixlet)){
											check++;
										}
									}
								}
								else if (i==8){
									check++;
								}
								else{
									if((puzx[i]+piecewidth>puzx[i+1]-pixlet)&&(puzx[i]+piecewidth<puzx[i+1]+pixlet)){
										if((puzy[i]  > puzy[i+1]-pixlet) && ( puzy[i] < puzy[i+1]+pixlet)){
											check++;
										}
									}
								}
							}

							//check if all of the pieces are correct
							if(check == 9){
								//pieces are organized
								message.displayMess("You solved the puzzle!");
                                openShuffle.play();
								check = 0;
								puzzleComplete = true;
								var puzzleKeyAnim = setInterval(function(){
									if(puzzleKeyY>400){
										clearInterval(puzzleKeyAnim);

									}
									else{
										puzzleKeyY++;
									}
								},20);

							}
							else{
								check = 0;
							}
						}
					});
					events.addRegionEventListener("mouseout", function () {
						document.body.style.cursor = "default";
					});
					events.addRegionEventListener("mousemove", function () {
						document.body.style.cursor = "pointer";
					});
					events.closeRegion();


				}

			},
			//portrait events
			function(){
				if(safeOpen){
                    eventArrow(900, 640, 1);
					getItemEvent(0,0,480,700,function(){
						openShuffle.play();
						portraitOpen = !portraitOpen;
						portraitOpening = true;
						setTimeout(function(){ portraitOpening = false; }, 500);
						safeOpen = false;
					});
					if(!hasBedroomKey){

						getItemEvent(650, 220, 200, 200,function(){
							hasBedroomKey = true;
                            bing.play();
							message.displayMess("You found a key!");
						});
					}
				}
				else if(portraitOpen){
                    eventArrow(900, 640, 1);
					getItemEvent(0,0,480,700,function(){
						openShuffle.play();
						portraitOpen = !portraitOpen;
						portraitOpening = true;
						setTimeout(function(){ portraitOpening = false; }, 500);
						safeOpen = false;
					});
					getItemEvent(760,445,200,70,function(){
						//check if code is correct
						var equal = 0;
						for(i=0;i<4;i++){

							if(portraitInput[i]==portraitCode[i]){
								equal++;
							}

						}

						if(equal==4){
							//pasword correct
							bing.play();
							safeOpen = true;
							message.displayMess("Password is correct");

						}
						else{
							//play error sound
//							bing.play();
                            wrongPass.play();
						}
					});
					//button events
					getItemEvent(560,170,70,70,function(){newInputPortrait(true,0);});
					getItemEvent(660,170,70,70,function(){newInputPortrait(true,1);});
					getItemEvent(760,170,70,70,function(){newInputPortrait(true,2);});
					getItemEvent(860,170,70,70,function(){newInputPortrait(true,3);});
					getItemEvent(560,355,70,70,function(){newInputPortrait(false,0);});
					getItemEvent(660,355,70,70,function(){newInputPortrait(false,1);});
					getItemEvent(760,355,70,70,function(){newInputPortrait(false,2);});
					getItemEvent(860,355,70,70,function(){newInputPortrait(false,3);});
				}
				else{
                    eventArrow(900, 640, 1);
					//to open portrait
					getItemEvent(490,60,500,550,function(){
						openShuffle.play();
						portraitOpen = !portraitOpen;
						portraitOpening = true;
						setTimeout(function(){ portraitOpening = false; }, 500);
						safeOpen = false;
					});

				}
			},
			//drawer events
			function(){
				if(!drawerOpening){
                    eventArrow(900, 630, 1);
					if (!drawerOpen) {
						//draw event shape on the location for the drawer closed
						getItemEvent(240, 370, 520, 100, function(){
							if(dragging=="drawerkey"){
								dragging  = null;
								openShuffle.play();
								drawerOpening = true;
								drawerOpen = !drawerOpen;
								setTimeout(function(){ drawerOpening = false; }, 500);
							}
							else{
                                lockedSound.play();
								message.displayMess("You need a key");
							}
						});
					}
					else {
						//draw event on location for drawer open
						getItemEvent(110, 600, 780, 95, function(){
								openShuffle.play();
								drawerOpening = true;
								drawerOpen = !drawerOpen;
								setTimeout(function(){ drawerOpening = false; }, 500);

						});


					}
				}

			},
			//xylophone events
			function(){

				if(xylophoneOpen){
                    eventArrow(900, 50, 1);
				}
				else{
                    eventArrow(900, 50, 1);
				}
				//get xylophone coordinates

				events.beginRegion();
				events.context.beginPath();
				//events.context.fillStyle = "#00D2FF";
				events.context.rect(3,3,994,694);
				events.context.closePath();
				//events.context.fill();
				events.addRegionEventListener("mousemove",function(){
					var posi = events.getMousePos();
					stickX = posi.x ;
					stickY = posi.y ;
				});
				events.closeRegion();


				events.beginRegion();
				events.context.beginPath();
				//events.context.lineWidth = 4;
				//events.context.strokeStyle = "black";
				//events.context.fillStyle = "#00D2FF";
				events.context.rect(0,322,1000,378);
				events.context.closePath();
				//events.context.fill();
				//events.context.stroke();
				events.addRegionEventListener("mousedown",function(){
					if(hasStick){
						for (var i = 0; i < 7; i++) {
							if (noteRow[i].keyDidPlay()) {
								noteRow[i].playSelf();
							}
						}
					}
					else{
						message.displayMess("You need a stick");
					}
				});
				events.closeRegion();

				if(hasStick){
					document.body.style.cursor = "none";	//no cursor
				}
				else{
					document.body.style.cursor = "default";
				}



			},
			//hallway events
			function(){
                createEventShape(670, 40, 860, 210, 850, 590, 665, 440, 7); // bedroom door event region
//				createEventBox(0,0,100,50,0); // debugging event
                createEventShape(190, 380, 550, 700, 0, 700, 0, 630, 1); // stairs event region
			},
			//bedroom events
			function(){
				if(!bedroomOpening&&!bedroomOpening2){
//					createEventBox(0,0,100,50,0); // debugging event
                    eventArrow(900, 630, 6);
					if(bedroomOpen){
						//change coordinates to correct door location
						getItemEvent(670, 10, 310, 530,function(){toggledoor();});
						if(!hasMainKey){
							getItemEvent(460, 400, 100,100,function(){
								hasMainKey = true;
                                bing.play();
								message.displayMess("You found a key!");
							});
						}
					}
					else{

						getItemEvent(345, 10, 310, 530,function(){toggledoor();});
					}
				}
			},
			//win events
			function(){

			},
			//death by monster screen, events
			function(){
				getItemEvent(270,430,460,222,function(){
					restartGame();
				});
			},
			//death by timer events
			function(){
				getItemEvent(270,430,460,222,function(){
					restartGame();
				});
			}
		];


	}

	function game(){
		events = new Events("canvasOne");
		var anim = new Animation("canvasOne");
		var canvas = anim.getCanvas();
		var context = anim.getContext();


		//mouse coordinates when dragging
		var mouseC = {x:0,y:0}

		//coordinates for items
		var bedroomKCoor = {x:20,y:40};
		var drawerKCoor = {x:20,y:160};
		var mainKCoor = {x:20,y:220};



		createScreens(); //create function arrays to handle drawing and events

		document.addEventListener("keypress", function(event) {
			toolbox = !toolbox;
		});

		events.setStage(function () {
			document.body.style.cursor = "default";
			drawEvents[currentScreen]();
			if(toolbox && currentScreen > 0 && currentScreen < 8){

				if(hasBedroomKey){
					dragEvent(20, 40, 50, 50,function(){
						dragging = "bedroomkey";
					});
				}
				if(hasDrawerKey){
					dragEvent(20, 160, 50, 50,function(){
						dragging = "drawerkey";
					});
				}
				if(hasMainKey){
					dragEvent(20, 220, 50, 50,function(){
						dragging = "mainkey";
					});
				}

			}
			if(dragging){
					mouseC.x = window.event.clientX *(1000/window.innerWidth) ;
					mouseC.y = window.event.clientY *(700/window.innerHeight) ;
			}

		});


		anim.setStage(function() {
			//change canvas dimensions according to user
			var height = window.innerHeight;
			var width = window.innerWidth;

			canvas.style.width = width+'px';
			canvas.style.height = height+'px';

			this.clear();
			screens[currentScreen]();
			drawEvents[currentScreen]();	//for debug

			if(toolbox && currentScreen > 0 && currentScreen < 8){
				//draw toolbox
				events.context.beginPath();
				events.context.rect(0, 0, 100, 400);
				events.context.lineWidth = 4;
				events.context.strokeStyle = "black";
				events.context.fillStyle = "#FFFFFF";
				events.context.fill();
				events.context.stroke();
				events.context.closePath();

				events.context.font = "25px Georgia";
				events.context.fillStyle= "black";
				events.context.fillText("ToolBox", 4, 25);


				if(hasBedroomKey){
					if(dragging=="bedroomkey"){
						events.context.drawImage(images["key2"], mouseC.x, mouseC.y, 50, 50);
					}
					else{
						events.context.drawImage(images["key2"], bedroomKCoor.x, bedroomKCoor.y, 50, 50);
					}


				}
				if(hasWeapon){
					events.context.drawImage(images["poker"], 30, 100, 50, 50);
				}
				if(hasDrawerKey){

					if(dragging=="drawerkey"){
						events.context.drawImage(images["keyfrompuzzle"], mouseC.x, mouseC.y, 50, 50);
					}
					else{
						events.context.drawImage(images["keyfrompuzzle"], drawerKCoor.x, drawerKCoor.y, 50, 50);
					}
				}
				if(hasMainKey){

					if(dragging=="mainkey"){
						events.context.drawImage(images["redkey"], mouseC.x, mouseC.y, 50, 50);
					}
					else{
						events.context.drawImage(images["redkey"], mainKCoor.x, mainKCoor.y, 50, 50);
					}
				}
				if(hasStick){
					events.context.beginPath();
					events.context.arc(47, 300, 10, 0, 2 * Math.PI, true);
					events.context.fillStyle = "#FF6A6A";
					events.context.strokeStyle = "#FF6A6A";
					events.context.lineWidth = 7;
					events.context.closePath();
					events.context.fill();

					events.context.beginPath();
					events.context.lineWidth = 2;
					events.context.moveTo(47 , 300);
					events.context.lineTo(47, 340);
					events.context.stroke();
					events.context.closePath();
				}
			}


			message.drawMessage();

			//timer
			if(currentScreen>0 && currentScreen<8){
				timer.drawTime(900,680);
			}


		});
		anim.start();
	}

    window.onload = function() {
		init();
	}
</script>
</body>
</html>
