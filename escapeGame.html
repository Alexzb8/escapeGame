<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ECS521 Project: Escape Game</title>
<style>
body{
	background-color:black;
	margin: 0;
}
#game{
	display:block;
	width :1200px;
	margin-left: auto;
	margin-right: auto;
}
#canvasOne{
	margin:0;
}
#canvasTwo{
	background-color:white;
	margin:0;
}
</style>
</head>
<body>
<div id="game">
	<canvas id = "canvasTwo" width = "200" height = "700"></canvas
    ><canvas id = "canvasOne" width = "1000" height = "700"></canvas>
</div>
<script type="text/javascript" src="Events.js"></script>
<script type="text/javascript" src ="Animation.js"></script>
<script type="text/javascript">

    /**TODO:
	 * Add audio file loader
	 * play ambient audio file
	 * add object close ups
	 *




     * Screen 0: start screen
     * 1: basic living room view
     * 2: up close puzzle view
     * 3: up close portrait painting view
     * 4: up close desk drawer view
     * 5: up close xylophone view
     * 6: hallway view
     * 7: up close bedroom door
     * 8: winning screen
     * 9: death by monster screen
     * 10: death by timer screen
	   11: LAMP TOGGLE
     */
    var currentScreen = 0;
    var timer = 0;
	var totalResources = 23;
	var numResourcesLoaded = 0;
	var finishedLoading = false;
	var images = {};
	var hasBedroomKey = false; // until they get it from the portrait
    var hasWeapon = false; // until they get the fire poker
    var hasStick = false; // until they get the stick from the lampshade
    var lampOn = false;

	// Returns a random integer between min (included) and max (included)
	// Using Math.round() will give you a non-uniform distribution!
	function random(min, max) {
	  min = Math.ceil(min);
	  max = Math.floor(max);
	  return Math.floor(Math.random() * (max - min + 1)) + min;
	}

	function loadImage(name) {
		//add image to images array and check if loaded
		images[name] = new Image();
		images[name].onload = function() {
			resourceLoaded();
		}
		images[name].src = "./images/" + name + ".png";
	}
	function resourceLoaded() {
		//check if all images are loaded
		numResourcesLoaded += 1;
		if(numResourcesLoaded === totalResources) {
			finishedLoading = true;
		}
	}
    function init(events) {
        var canvas = events.getCanvas();
        var context = events.getContext();

		//loading prompt for user
		context.fillStyle="white";
		context.font = "100px Georgia";
		context.fillText("loading...", 40, 140);

		//load images
		loadImage("SCREEN1");
		loadImage("SCREENGAMEOVER");
		loadImage("SCREENMONSTER");
		loadImage("SCREENWIN");
		loadImage("opendoor");
		loadImage("monster");
		loadImage("livingroom");
		loadImage("hallway");
		loadImage("closeddoor");
		loadImage("fire1");
		loadImage("fire2");
		loadImage("fire3");
		loadImage("xylophone");
		loadImage("table");
		for(i=0;i<9;i++){
			loadImage(i);
		}
        loadImage("lamplightingafter");
        loadImage("lampwithoutstick");

		//check if images are loaded on interval of 1 ms
		var checkloaded = setInterval(function(){
			if(finishedLoading){
				clearInterval(checkloaded); //end loop
				continueGame(events);
			}
		},1);
    }
    function changeScreen(screen,events){
		//clone canvas to get rid of previous events
		var clone = events.canvas.cloneNode();
		while (events.canvas.firstChild) {
		  clone.appendChild(events.canvas.lastChild);
		}
		events.canvas.parentNode.replaceChild(clone, events.canvas);
		//change screen and continue game
		currentScreen = screen;
		console.log("to screen: " + screen);
		continueGame(events);
	}
	function createEventBox(x,y,width,height,screen,events){
		events.beginRegion();
		events.context.beginPath();
		events.context.rect(x, y, width, height);
		events.context.lineWidth = 4;
		events.context.strokeStyle = "black";
		events.context.fillStyle = "#00D2FF";
		events.context.fill();
		events.context.stroke();
		events.context.closePath();
		events.addRegionEventListener("mousedown",function(){
			if (screen==11){
				console.log("click on lamp");
				lampOn = !lampOn;
				changeScreen(1,events);
			}
			else {
			changeScreen(screen,events);
			}			
		});
		events.addRegionEventListener("mouseout", function () {
			document.body.style.cursor = "default";
			//console.log("mouseout");
		});
		events.addRegionEventListener("mouseover", function () {
			document.body.style.cursor = "pointer";
			//console.log("mouseover");
		});
		events.closeRegion();
	}
	function checkregion(mouse){

	}
	function continueGame(events) {

		events = new Events("canvasOne");

        if      (currentScreen == 0) {
			events.setStage(function () {
				this.clear();
				events.context.drawImage(images["SCREEN1"], 0, 0, events.canvas.width, events.canvas.height);
				createEventBox(270,430,460,222,1,events);
			});
        }
		else if (currentScreen == 1) {
			console.log("lampon: "+lampOn+"  hasStick : "+hasStick);
			var fireCount = 1;

			//draw fireplace
			var fireplace = setInterval(function(){

				if(currentScreen!=1){
					clearInterval(fireplace); //end loop
				}
				events.clear();

                if (lampOn == false) {
                    events.context.drawImage(images["livingroom"], 0, 0, events.canvas.width, events.canvas.height);
                } else if (lampOn == true && hasStick == false) {
                    events.context.drawImage(images["lamplightingafter"], 0, 0, events.canvas.width, events.canvas.height);
                } else if (lampOn == true && hasStick == true) {
                    events.context.drawImage(images["lampwithoutstick"], 0, 0, events.canvas.width, events.canvas.height);
                }
				if(hasWeapon){}


				events.context.drawImage(images["fire"+fireCount ], 170, 170, 200, 200);
				fireCount++;
				if(fireCount==4){
					fireCount=1;
				}

			},100);



			events.setStage(function () {
				//events.clear();
				//events.context.drawImage(images["livingroom"], 0, 0, events.canvas.width, events.canvas.height);
				//events.context.drawImage(images["fire"+fireCount ], 170, 170, 200, 200);

				createEventBox(0,0,100,50,0,events);
				createEventBox(880,0,120,350,6,events);
				createEventBox(400,380,220,120,2,events);
				createEventBox(100,400,100,100,5,events);
                createEventBox(375, 20, 80, 80, 11, events);
			});

        }
		else if (currentScreen == 6) {

			events.setStage(function () {
				this.clear();
				events.context.drawImage(images["hallway"], 0, 0, events.canvas.width, events.canvas.height);
				createEventBox(0,0,100,50,0,events);
				createEventBox(0,450,430,250,1,events);
				createEventBox(670,40,200,550,7,events);
			});

        }
		else if (currentScreen == 7) {

			events.setStage(function () {
				this.clear();
				events.context.drawImage(images["closeddoor"], 0, 0, events.canvas.width, events.canvas.height);
				createEventBox(0,0,100,50,0,events);
				createEventBox(0,550,1000,150,6,events);
			});

        }
		else if (currentScreen == 5) {

			events.setStage(function () {
				this.clear();
				events.context.drawImage(images["xylophone"], 0, 0, events.canvas.width, events.canvas.height);
			});

            var canvas = document.getElementById("canvasOne");
            var canvasPos = getCanvasPosition(canvas);
            var cursorX = 0;
            var cursorY = 0;

            canvas.addEventListener("mousemove", setCursor, false);
            canvas.addEventListener("click", clickNote, false);
            drawStick();


            function getCanvasPosition(element) {
                var x = 0;
                var y = 0;

                while (element) {
                    x += (element.offsetLeft - element.scrollLeft + element.clientLeft);
                    y += (element.offsetTop - element.scrollTop + element.clientTop);
                    element = element.offsetParent;
                }
                return {
                    x: x,
                    y: y
                };
            }

            function setCursor(event) {
                cursorX = event.clientX - canvasPos.x;
                cursorY = event.clientY - canvasPos.y;
            }

            function drawStick() {
                events.context.beginPath();
                events.context.arc(cursorX, cursorY, 30, 0, 2 * Math.PI, true);
                events.context.fillStyle = "#FF6A6A";
                events.context.strokeStyle = "#FF6A6A";
                events.context.lineWidth = 7;
                events.context.closePath();
                events.context.fill();

                events.context.beginPath();
                events.context.moveTo(cursorX + 15, cursorY + 15);
                events.context.lineTo(cursorX + 130, cursorY + 130);
                events.context.stroke();
                requestAnimationFrame(drawStick);
            }

            function clickNote(event) {
                console.log("click!");
                var clickX = event.clientX - canvasPos.x;
                var clickY = event.clientY - canvasPos.y;

                console.log(clickX, clickY);

                
            }

        }
		else if (currentScreen == 2) {
			//puzzle
			var draggingRect = [false,false,false,false,false,false,false,false,false];
			var check = 0;			
			var draggingRectOffsetX = [0,0,0,0,0,0,0,0,0];
			var draggingRectOffsetY = [0,0,0,0,0,0,0,0,0];
			var puzx = [100, 300, 500,100, 300, 500,100, 300, 500];
			var puzy = [100, 100, 100,300,300,300,500,500,500];
			var piecewidth = 100;
			var context = events.context;
			var pixlet = 10;//how many pixels we can be not correctly placed

			events.setStage(function () {
				var mousePos = this.getMousePos();
				for(i=0;i<9;i++){
					if (draggingRect[i]) {
						puzx[i] = mousePos.x - draggingRectOffsetX[i];
						puzy[i] = mousePos.y - draggingRectOffsetY[i];
					}				
				}
				
				//now check if they are correctly organized;
				for(i=0;i<9;i++){
					if(i==2||i==5){
						if((puzx[i]-(piecewidth*2)>puzx[i+1]-pixlet)&&(puzx[i]-(piecewidth*2)<puzx[i+1]+pixlet)){
						
							if((puzy[i] + piecewidth > puzy[i+1]-pixlet)&&(puzy[i] + piecewidth < puzy[i+1]+pixlet)){
								check++;
								console.log("piece: "+ i);
							}
						}				
					}
					else if (i==8){
						check++;
					}
					else{
						if((puzx[i]+piecewidth>puzx[i+1]-pixlet)&&(puzx[i]+piecewidth<puzx[i+1]+pixlet)){
							if((puzy[i]  > puzy[i+1]-pixlet) && ( puzy[i] < puzy[i+1]+pixlet)){
								check++;
								console.log("piece: "+ i);
							}							
						}						
					}					
				}				
				//check if all of the pieces are correct
				if(check == 9){
					console.log("pieces are organized");
					check = 0;
				}
				else{
					check = 0;
				}
			
				this.clear();
				events.context.drawImage(images["table"], 0, 0, events.canvas.width, events.canvas.height);				
				createEventBox(0,0,100,50,0,events);
				
				for(i=0;i<9;i++){		

					this.beginRegion();
					context.rect(puzx[i], puzy[i], piecewidth,piecewidth);
					this.addRegionEventListener("mousedown", function(){
						draggingRect[i] = true;
						var mousePos = events.getMousePos();
						draggingRectOffsetX[i] = mousePos.x - puzx[i];
						draggingRectOffsetY[i] = mousePos.y - puzy[i];
					});
					this.addRegionEventListener("mouseup", function(){
						draggingRect[i] = false;
					});
					this.addRegionEventListener("mouseout", function () {
						document.body.style.cursor = "default";
						console.log("mouseout");
					});
					this.addRegionEventListener("mouseover", function () {
						document.body.style.cursor = "pointer";
						console.log("mouseover");
					});
					this.closeRegion();
				
					events.context.drawImage(images[i], puzx[i], puzy[i], 100, 100);
					
				}
						
				
			});

        }
	}


    // if they click on the bedroom door AFTER they are at the close up view (not if they are just inside the hallway still)
    function attemptUnlockUpCloseBedroomDoor(canvas,context) {
        if (hasBedroomKey && hasWeapon) {
                context.drawImage(images["opendoor"], 0, 0, canvas.width, canvas.height);

            // then play the video of beating the monster and getting the key
        } else if (hasBedroomKey && ! hasWeapon) {
            context.drawImage(images["monster"], 0, 0, canvas.width, canvas.height);

            // then play the video of getting killed by the monster

            // then take user to end screen
			context.drawImage(images["SCREENMONSTER"], 0, 0, canvas.width, canvas.height);


        } else {
            // play some kind of "locked door" sound, display text of "door is locked"
        }
    }


    window.onload = function() {
		var events = new Events("canvasOne");

		init(events);


	}
</script>

</body>
</html>
