<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ECS521 Project: Escape Game</title>
<style>
body{
	background-color:black;
	margin: 0;
}
#game{
	display:block;
	width :1200px;
	margin-left: auto;
	margin-right: auto;
}
#canvasOne{
	margin:0;
}
#canvasTwo{
	background-color:white;
	margin:0;
}
</style>
</head>
<body>
<div id="game">
	<canvas id = "canvasTwo" width = "200" height = "700"></canvas
    ><canvas id = "canvasOne" width = "1000" height = "700"></canvas>
</div>

<script type="text/javascript" src="Events.js"></script>
<script type="text/javascript" src ="Animation.js"></script>
<script type="text/javascript" src ="audio.js"></script>
<script type="text/javascript">

    /**TODO:
	 * Add audio file loader
	 * play ambient audio file
	 * add object close ups
	 *




     * Screen 0: start screen
     * 1: basic living room view
     * 2: up close puzzle view
     * 3: up close portrait painting view
     * 4: up close desk drawer view
     * 5: up close xylophone view
     * 6: hallway view
     * 7: up close bedroom door
     * 8: winning screen
     * 9: death by monster screen
     * 10: death by timer screen
	   11: LAMP TOGGLE
        12: drawer opening screen
     13: bedroom door opening screen
     */
    var currentScreen = 1;
    var timer = 0;
	var totalResources = 30;
	var numResourcesLoaded = 0;
	var finishedLoading = false;
	var images = {};
	var hasBedroomKey = true; // until they get it from the portrait
    var hasWeapon = true; // until they get the fire poker
    var hasStick = false; // until they get the stick from the lampshade
    var lampOn = false;
	var puzzleComplete = false;
	var puzx = [690, 228, 776, 415, 444, 622, 216, 59, 475 ];
	var puzy = [380, 132, 217,  90, 259,  91, 391,254, 440 ];
	var solvedXylo = false;
	var cursorX = -500;
    var cursorY = 0;
	var currentnote = null;
	var alpha = 1.0;
    var hasDrawerKey = true; // until they get it from the puzzle
    var drawerOpened = false;
	//define global loop for later use
	var intervalLoop;

    var bedroomOpen = false;


    // xylophone notes
    var noteRow = [];

	//create xylophone puzzle notes
	var noteLetters = ["C","D","E","F","G","A","B"];
	var xylophoneAnswer = [];
	var numNotes = 6;            //number of notes user has to input
	var inputNotes = [numNotes];
	var noteString = "";
	for(i = 0 ; i<numNotes;i++){
		xylophoneAnswer[i] = random(0,6);

		if(i==0){
			noteString = noteString +  noteLetters[xylophoneAnswer[i]];
		}
		else{
			noteString = noteString +", " +  noteLetters[xylophoneAnswer[i]];
		}
	}
	console.log(xylophoneAnswer);
	console.log(noteString);


	// Returns a random integer between min (included) and max (included)
	function random(min, max) {
	  min = Math.ceil(min);
	  max = Math.floor(max);
	  return Math.floor(Math.random() * (max - min + 1)) + min;
	}
	function newNote(note,events){
		//input new note into array and check if all notes are equal

		var equal = 0;
		var i = 0;

		for(i=0;i<numNotes-1;i++){
			inputNotes[i] = inputNotes[i+1];
			if(inputNotes[i]==xylophoneAnswer[i]){equal++;}
		}

		inputNotes[i] = note;
		if(inputNotes[i]==xylophoneAnswer[i]){

			equal++;
			if(equal==6){
				//puzzle is solved
				solvedXylo = true;
				//clear interval
				clearTimeout(intervalLoop);
				changeScreen(1,events);
			}

		}



	}
	function loadImage(name) {
		//add image to images array and check if loaded
		images[name] = new Image();
		images[name].onload = function() {
			resourceLoaded();
		}
		images[name].src = "./images/" + name + ".png";
	}
	function resourceLoaded() {
		//check if all images are loaded
		numResourcesLoaded += 1;
		if(numResourcesLoaded === totalResources) {
			finishedLoading = true;
		}
	}
    function init(events) {
        var canvas = events.getCanvas();
        var context = events.getContext();

		//loading prompt for user
		context.fillStyle="white";
		context.font = "100px Georgia";
		context.fillText("loading...", 40, 140);

		//load images
		loadImage("SCREEN1");
		loadImage("SCREENGAMEOVER");
		loadImage("SCREENMONSTER");
		loadImage("SCREENWIN");
		loadImage("monster");
		loadImage("livingroom");
		loadImage("hallway");
		loadImage("closeddoor");
		loadImage("fire1");
		loadImage("fire2");
		loadImage("fire3");
		loadImage("fire3dark");
		loadImage("fire2dark");
		loadImage("fire1dark");
		loadImage("xylophone");
		loadImage("table");
		loadImage("puzzleboxwpieces");
		loadImage("puzzleboxwpiecesdark");
        loadImage("drawerhalfopened");
        loadImage("drawerclosed");
        loadImage("draweropened");
        loadImage("deathdoorangled");
        loadImage("deathdoorangled2");
        loadImage("deathdoorangledwithmonster");

		for(i=0;i<9;i++){
			loadImage(i);
		}
        loadImage("lamplightingafter");
        loadImage("lampwithoutstick");

		//check if images are loaded on interval of 1 ms
		var checkloaded = setInterval(function(){
			if(finishedLoading){
				clearInterval(checkloaded); //end loop
				continueGame(events);
			}
		},1);

        // fill in each note of the close-up xylophone
        noteRow[0] = new Note(0,"cNote", 17, 334, 175,
            688, context);
        noteRow[1] = new Note(1,"dNote", 184, 359, 332,
            683, context);
        noteRow[2] = new Note(2,"eNote", 336, 371, 472,
            673, context);
        noteRow[3] = new Note(3,"fNote", 473, 381, 607,
            673, context);
        noteRow[4] = new Note(4,"gNote", 615, 390, 742,
            673, context);
        noteRow[5] = new Note(5,"aNote", 746, 397, 868,
            665, context);
        noteRow[6] = new Note(6,"bNote", 873, 405, 989,
            665, context);



    }
    function changeScreen(screen,events){
		//clone canvas to get rid of previous events
		var clone = events.canvas.cloneNode();
		while (events.canvas.firstChild) {
		  clone.appendChild(events.canvas.lastChild);
		}
		events.canvas.parentNode.replaceChild(clone, events.canvas);
		//change screen and continue game
		currentScreen = screen;
		continueGame(events);
	}
	function createEventBox(x,y,width,height,screen,events){
		//try setting stage here
		events.beginRegion();
		events.context.beginPath();
		events.context.rect(x, y, width, height);
		events.context.lineWidth = 4;
		events.context.strokeStyle = "black";
		events.context.fillStyle = "#00D2FF";
		events.context.fill();
		events.context.stroke();
		events.context.closePath();
		events.addRegionEventListener("mouseup",function(){
			//clear interval
			clearTimeout(intervalLoop);
			changeScreen(screen,events);

		});
		events.addRegionEventListener("mouseout", function () {
			document.body.style.cursor = "default";
			//console.log("mouseout");
		});
		events.addRegionEventListener("mouseover", function () {
			document.body.style.cursor = "pointer";
			//console.log("mouseover");
		});
		events.closeRegion();
	}
	function createEventShape(x,y,x1,y1,x2,y2,x3,y3,screen,events){
		//try setting stage here

		events.context.save();
		events.beginRegion();
		events.context.beginPath();
		events.context.lineWidth = 4;
		events.context.strokeStyle = "black";
		events.context.fillStyle = "#00D2FF";
		events.context.moveTo(x,y);
		events.context.lineTo(x1,y1);
		events.context.lineTo(x2,y2);
		events.context.lineTo(x3,y3);
		events.context.closePath();
		events.context.fill();
		events.context.stroke();
		events.addRegionEventListener("mouseup",function(){
			//clear interval
				clearTimeout(intervalLoop);
			changeScreen(screen,events);

		});
		events.addRegionEventListener("mouseout", function () {
			document.body.style.cursor = "default";
			//console.log("mouseout");
		});
		events.addRegionEventListener("mouseover", function () {
			document.body.style.cursor = "pointer";
			//console.log("mouseover");
		});
		events.closeRegion();


		events.context.restore();
	}
	function checkregion(mouse){

	}
	function drawStick(events) {
		events.context.beginPath();
		events.context.arc(cursorX, cursorY, 30, 0, 2 * Math.PI, true);
		events.context.fillStyle = "#FF6A6A";
		events.context.strokeStyle = "#FF6A6A";
		events.context.lineWidth = 7;
		events.context.closePath();
		events.context.fill();

		events.context.beginPath();
		events.context.moveTo(cursorX + 15, cursorY + 15);
		events.context.lineTo(cursorX + 130, cursorY + 130);
		events.context.stroke();
		events.context.closePath();
	}
    // defining each note on the xylophone
    function Note(num, note, topLeftX, topLeftY, topRightX, bottomLeftY, context) {
        this.ctx = context;

        this.note = note;
		this.noteNum = num;
		this.noteAudio = AudioFX('audio/'+note,   { formats: ['wav'], pool: 10 });

        //x and y coordinates of the outline of the key
        this.topLeftX = topLeftX;
        this.topLeftY = topLeftY;
        this.topRightX = topRightX;
        this.bottomLeftY = bottomLeftY;

        this.width = topRightX - topLeftX;
        this.height = bottomLeftY - topLeftY;
		this.drawBox = function(events){
			ctx = events.context;
			ctx.save();
			ctx.beginPath();
			ctx.rect(this.topLeftX, this.topLeftY, this.width, this.height);
			ctx.fillStyle = "rgba(255, 0, 0, " + alpha + ")";
			ctx.fill();
			ctx.closePath();
			ctx.restore();
		};
    }
    Note.prototype.playSelf = function(events) {
		this.noteAudio.play();
		//update and check note input array
      	newNote(this.noteNum,events);
    };
    Note.prototype.keyDidPlay = function(stickX, stickY) {
        if (stickX >= this.topLeftX && stickX <= this.topRightX
            && stickY >= this.topLeftY && stickY <= this.bottomLeftY) {
            return true;
        } else {
            return false;
        }
    };

	function continueGame(events) {

		events = new Events("canvasOne");

        if (currentScreen == 0) {
			events.setStage(function () {
				this.clear();
				events.context.drawImage(images["SCREEN1"], 0, 0, events.canvas.width, events.canvas.height);
				createEventBox(270,430,460,222,1,events);
			});
        }
		else if (currentScreen == 1) {
			var fireCount = 1;
			var fireplace = null;


			function livingLoop(){
				events.clear();

                events.context.drawImage(images["livingroom"], 0, 0, events.canvas.width, events.canvas.height);
                events.context.drawImage(images["puzzleboxwpieces"], 440, 370, 120, 120);

				if(hasWeapon){}


				events.context.drawImage(images["fire"+fireCount ], 170, 170, 200, 200);
				fireCount++;
				if(fireCount==4){
					fireCount=1;
				}
			}

			livingLoop();
			intervalLoop = setInterval(livingLoop,100);



			events.setStage(function () {

				createEventBox(0,0,100,50,0,events);
				createEventShape(880,0,1000,0,1000,360,880,260,6,events);
				if(!solvedXylo){
					createEventShape(7,520,229,385,265,416,77,590,5,events);
				}
				createEventShape(400,24,430,24,448,90,387,90,11,events);
				if(!puzzleComplete){
					createEventBox(400,380,220,120,2,events);
				}
                createEventBox(510, 150, 130, 20, 4, events);

			});

        }
		else if (currentScreen == 6) {

			events.setStage(function () {
				this.clear();
				events.context.drawImage(images["hallway"], 0, 0, events.canvas.width, events.canvas.height);
				createEventBox(0,0,100,50,0,events);
				createEventBox(0,450,430,250,1,events);
                createEventBox(670,40,200,550,7,events);
			});

        }
		else if (currentScreen == 7) {

			if (bedroomOpen == false ) {
			    events.setStage(function () {
                    this.clear();
                    events.context.drawImage(images["closeddoor"], 0, 0, events.canvas.width, events.canvas.height);
                    createEventBox(0,0,100,50,0,events);
                    createEventBox(0,550,1000,150,6,events);

                    // to open the door
                    if (hasBedroomKey == true) {
                        createEventBox(345, 10, 310, 530, 13, events);
                    }
                });
            } else {
                events.setStage(function () {
                    this.clear();
                    events.context.drawImage(images["deathdoorangled2"], 0, 0, events.canvas.width, events.canvas.height);
                    createEventBox(0,0,100,50,0,events);
                    createEventBox(0,550,1000,150,6,events);
                });
            }

        }

        else if (currentScreen == 4) {
            if (drawerOpened == false) {
                events.setStage(function () {
                    this.clear();
                    events.context.drawImage(images["drawerclosed"], 0, 0, events.canvas.width, events.canvas.height);
                    createEventBox(0,0,100,50,1,events); // BACK BUTTON

                    if (hasDrawerKey == true) {
                        createEventBox(240, 370, 520, 100, 12, events);
                    }
                });

            } else {
                events.setStage(function () {
                    this.clear();
                    events.context.drawImage(images["draweropened"], 0, 0, events.canvas.width, events.canvas.height);
                    events.context.font = "30px Arial";
                    events.context.fillStyle = "#000000";
                    events.context.fillText(noteString, 400, 550);

                    createEventBox(0,0,100,50,1,events); // BACK BUTTON
                });
            }

        }

		else if (currentScreen == 5) {


			var canvas = document.getElementById("canvasOne");
            var canvasPos = getCanvasPosition(canvas);
			var mousePos = events.getMousePos();
			var ongoingnote = null;
			var done = true;


			events.setStage(function () {
				document.body.style.cursor = "none";	//no cursor
			});

			//loop to draw xylophone

			function xyloLoop(){
				events.clear();

				events.context.drawImage(images["xylophone"], 0, 0, events.canvas.width, events.canvas.height);

				//check if there is a playing note to draw red box
				if(currentnote!=null){

					if(done){
						done = false;
						ongoingnote = currentnote;
					}
					if(currentnote!=ongoingnote){
						alpha = 1.0;
						ongoingnote = currentnote;
					}
					//draw red box
					noteRow[currentnote].drawBox(events);

					//decrease alpha value and check if animation is done
					alpha = alpha - .04;
					if(alpha<0){
						currentnote = null ;
						alpha = 1.0;
					}
				}
				drawStick(events);
			}

			xyloLoop();

			intervalLoop = setInterval(xyloLoop,10);


            canvas.addEventListener("mousemove", function(){
				mousePos = events.getMousePos();
                cursorX = mousePos.x ;
                cursorY = mousePos.y ;

			}, false);
            canvas.addEventListener("mousedown", function(){

                for (var i = 0; i < 7; i++) {
                    if (noteRow[i].keyDidPlay(cursorX, cursorY)) {
                        noteRow[i].playSelf(events);
						currentnote = i;
                    }
                }
			}, false);




            function getCanvasPosition(element) {
                var x = 0;
                var y = 0;

                while (element) {
                    x += (element.offsetLeft - element.scrollLeft + element.clientLeft);
                    y += (element.offsetTop - element.scrollTop + element.clientTop);
                    element = element.offsetParent;
                }
                return {
                    x: x,
                    y: y
                };
            }




        }
		else if (currentScreen == 2) {
			//puzzle
			var draggingRect = [false,false,false,false,false,false,false,false,false];
			var check = 0;
			var draggingRectOffsetX = [0,0,0,0,0,0,0,0,0];
			var draggingRectOffsetY = [0,0,0,0,0,0,0,0,0];
			var piecewidth = 100;
			var context = events.context;
			var pixlet = 10;//how many pixels we can be not correctly placed

			events.setStage(function () {
				var mousePos = this.getMousePos();
				for(i=0;i<9;i++){
					if (draggingRect[i]) {
						puzx[i] = mousePos.x - draggingRectOffsetX[i];
						puzy[i] = mousePos.y - draggingRectOffsetY[i];


					}

				}



				//now check if they are correctly organized;
				for(i=0;i<9;i++){
					if(i==2||i==5){
						if((puzx[i]-(piecewidth*2)>puzx[i+1]-pixlet)&&(puzx[i]-(piecewidth*2)<puzx[i+1]+pixlet)){

							if((puzy[i] + piecewidth > puzy[i+1]-pixlet)&&(puzy[i] + piecewidth < puzy[i+1]+pixlet)){
								check++;
							}
						}
					}
					else if (i==8){
						check++;
					}
					else{
						if((puzx[i]+piecewidth>puzx[i+1]-pixlet)&&(puzx[i]+piecewidth<puzx[i+1]+pixlet)){
							if((puzy[i]  > puzy[i+1]-pixlet) && ( puzy[i] < puzy[i+1]+pixlet)){
								check++;
							}
						}
					}
				}
				//check if all of the pieces are correct
				if(check == 9){
					check = 0;
					puzzleComplete = true;

				}
				else{
					check = 0;
				}

				this.clear();
				events.context.drawImage(images["table"], 0, 0, events.canvas.width, events.canvas.height);
				createEventBox(0,0,100,50,0,events);



				for(i=0;i<9;i++){

					this.beginRegion();
					context.rect(puzx[i], puzy[i], piecewidth,piecewidth);
					this.addRegionEventListener("mousedown", function(){
						draggingRect[i] = true;
						var mousePos = events.getMousePos();
						draggingRectOffsetX[i] = mousePos.x - puzx[i];
						draggingRectOffsetY[i] = mousePos.y - puzy[i];
					});
					this.addRegionEventListener("mouseup", function(){
						draggingRect[i] = false;
						if(puzzleComplete){
							changeScreen(1,events);
						}
					});
					this.addRegionEventListener("mouseout", function () {
						document.body.style.cursor = "default";
					});
					this.addRegionEventListener("mouseover", function () {
						document.body.style.cursor = "pointer";
					});
					this.closeRegion();

					events.context.drawImage(images[i], puzx[i], puzy[i], 100, 100);

				}


			});

        }
        else if (currentScreen == 9) {
            // GAME OVER BY MONSTER
            events.setStage(function () {
                this.clear();
                events.context.drawImage(images["SCREENMONSTER"], 0, 0, events.canvas.width, events.canvas.height);
                // TODO: RESET GAME
            });
        }

		else if (currentScreen == 11) {
			var fireCount = 1;
			var fireplace = null;


			function living2Loop(){
				events.clear();


                if (hasStick) {
					events.context.drawImage(images["lampwithoutstick"], 0, 0, events.canvas.width, events.canvas.height);

				}
				else{
					events.context.drawImage(images["lamplightingafter"], 0, 0, events.canvas.width, events.canvas.height);
				}
				events.context.drawImage(images["puzzleboxwpiecesdark"], 440, 370, 120, 120);

				if(hasWeapon){}


				events.context.drawImage(images["fire"+fireCount+"dark" ], 170, 170, 200, 200);
				fireCount++;
				if(fireCount==4){
					fireCount=1;
				}
			}

			living2Loop();

			intervalLoop = setInterval(living2Loop,100);



			events.setStage(function () {

				createEventBox(0,0,100,50,0,events);
				createEventShape(880,0,1000,0,1000,360,880,260,6,events);
				if(!solvedXylo){
					createEventShape(7,520,229,385,265,416,77,590,5,events);
				}
				createEventShape(400,24,430,24,448,90,387,90,1,events);
				if(!puzzleComplete){
					createEventBox(400,380,220,120,2,events);
				}

                createEventBox(510, 150, 130, 20, 4, events);

			});
		}

		else if (currentScreen == 12) {
            events.setStage(function () {
                createEventBox(0,0,100,50,1,events); // BACK BUTTON
            });

            var canvas = document.getElementById("canvasOne");
            // draw half open drawer first
            events.clear();
            events.context.drawImage(images["drawerhalfopened"], 0, 0, events.canvas.width, events.canvas.height);

            setTimeout(function(){
                events.clear();
                events.context.drawImage(images["draweropened"], 0, 0, events.canvas.width, events.canvas.height);
                events.context.font = "30px Arial";
                events.context.fillStyle = "#000000";
                events.context.fillText(noteString, 400, 550);
            }, 400);

            drawerOpened = true;

        }
        else if (currentScreen == 13) {
            events.setStage(function () {
                createEventBox(0,0,100,50,0,events); // EXIT BUTTONS
                createEventBox(0,550,1000,150,6,events);
            });

            bedroomOpen = true;

            var canvas = document.getElementById("canvasOne");
            events.clear();

            // if has weapon
            if (hasWeapon == true) {
                events.context.drawImage(images["deathdoorangled"], 0, 0, events.canvas.width, events.canvas.height);
                setTimeout(function(){
                    events.clear();
                    events.context.drawImage(images["deathdoorangledwithmonster"], 0, 0, events.canvas.width, events.canvas.height);

                    // TODO PLAY AUDIO OF MONSTER DYING

                    setTimeout(function(){
                        events.clear();
                        events.context.drawImage(images["deathdoorangled2"], 0, 0, events.canvas.width, events.canvas.height);
                    }, 400);

                }, 400);


            } else {

                events.context.drawImage(images["deathdoorangled"], 0, 0, events.canvas.width, events.canvas.height);
                setTimeout(function(){
                    events.clear();
                    events.context.drawImage(images["deathdoorangledwithmonster"], 0, 0, events.canvas.width, events.canvas.height);

                    // TODO PLAY AUDIO OF MONSTER DYING

                    setTimeout(function(){
                        changeScreen(9,events);
                    }, 400);
                }, 400);
            }



            // TODO: if does not have weapon, play audio and die


        }
	}

    window.onload = function() {
		var events = new Events("canvasOne");

		init(events);


	}
</script>

</body>
</html>
