<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ECS521 Project: Escape Game</title>
<style>
body{
	background-color:black;
	margin: 0;
}
#game{
	display:block;
	width :1200px;
	margin-left: auto;
	margin-right: auto;
}
#canvasOne{
	margin:0;
}
#canvasTwo{
	background-color:white;
	margin:0;
}
</style>
</head>
<body>
<div id="game">
	<canvas id = "canvasTwo" width = "200" height = "700"></canvas
    ><canvas id = "canvasOne" width = "1000" height = "700"></canvas>
</div>

<script type="text/javascript" src="Events.js"></script>
<script type="text/javascript" src ="Animation.js"></script>
<script type="text/javascript" src ="audio.js"></script>
<script type="text/javascript">

    /**
     * Screen 0: start screen
     * 1: basic living room view
     * 2: up close puzzle view
     * 3: up close portrait painting view
     * 4: up close desk drawer view
     * 5: up close xylophone view
     * 6: hallway view
     * 7: up close bedroom door
     * 8: winning screen
     * 9: death by monster screen
     * 10: death by timer screen
	   11: LAMP TOGGLE
     */
    var currentScreen = 1;
    var timer = 0;
	var totalResources = 30;
	var numResourcesLoaded = 0;
	var finishedLoading = false;
	var images = {};
	var hasBedroomKey = false; // until they get it from the portrait
    var hasWeapon = false; // until they get the fire poker
    var hasStick = false; // until they get the stick from the lampshade
	var lampOn = false;
	var puzzleComplete = false;
	var puzx = [488, 541, 337, 337, 250, 445, 225, 393, 193];
	var puzy = [495, 401, 306, 402, 255, 409, 443, 495, 345];
	var puzzleLocation = "";
	var solvedXylo = false;
	var cursorX = -500;
    var cursorY = 0;
	var currentnote = null;
	//define global loop for later use
	var intervalLoop;
	//global events
	var events;
	

    // xylophone notes
    var noteRow = [];
	
	//create xylophone puzzle notes
	var noteLetters = ["C","D","E","F","G","A","B"];
	var xylophoneAnswer = [];
	var numNotes = 6;            //number of notes user has to input
	var inputNotes = [numNotes];
	var noteString = "";	
	for(i = 0 ; i<numNotes;i++){
		xylophoneAnswer[i] = random(0,6);
		
		if(i==0){
			noteString = noteString +  noteLetters[xylophoneAnswer[i]];
		}
		else{
			noteString = noteString +", " +  noteLetters[xylophoneAnswer[i]];
		}
	}
	console.log(xylophoneAnswer);
	console.log(noteString);

	
	function clearIn(){
	console.log(intervalLoop);
	//clear intervals
		var i = 0;
		for(i=intervalLoop;i>0;i--){
			clearInterval(i);
		}
	
	}
	// Returns a random integer between min (included) and max (included)
	function random(min, max) {
	  min = Math.ceil(min);
	  max = Math.floor(max);
	  return Math.floor(Math.random() * (max - min + 1)) + min;
	}
	function newNote(note){
		//input new note into array and check if all notes are equal
		
		var equal = 0;
		var i = 0;
	
		for(i=0;i<numNotes-1;i++){
			inputNotes[i] = inputNotes[i+1];
			if(inputNotes[i]==xylophoneAnswer[i]){equal++;}
		}
		
		inputNotes[i] = note;
		if(inputNotes[i]==xylophoneAnswer[i]){
			
			equal++;
			if(equal==6){
				//puzzle is solved			
				solvedXylo = true;
				//clear interval
				
				clearIn();
				changeScreen(1);
			}
			
		}
		
		
	
	}
	function loadImage(name) {
		//add image to images array and check if loaded
		images[name] = new Image();
		images[name].onload = function() {
			resourceLoaded();
		}
		images[name].src = "./images/" + name + ".png";
	}
	function resourceLoaded() {
		//check if all images are loaded
		numResourcesLoaded += 1;
		if(numResourcesLoaded === totalResources) {
			continueGame();
		}
	}
    function init() {
        var canvas = events.getCanvas();
        var context = events.getContext();

		//loading prompt for user
		context.fillStyle="white";
		context.font = "100px Georgia";
		context.fillText("loading...", 40, 140);

		//load images
		loadImage("SCREEN1");
		loadImage("SCREENGAMEOVER");
		loadImage("SCREENMONSTER");
		loadImage("SCREENWIN");
		loadImage("opendoor");
		loadImage("monster");
		loadImage("livingroom");
		loadImage("hallway");
		loadImage("closeddoor");
		loadImage("fire1");
		loadImage("fire2");
		loadImage("fire3");
		loadImage("fire3dark");
		loadImage("fire2dark");
		loadImage("fire1dark");
		loadImage("xylophone");
		loadImage("table");
		loadImage("puzzleboxwpieces");
		loadImage("puzzleboxwpiecesdark");
		loadImage("puzzleopened");
		
		for(i=0;i<9;i++){
			loadImage(i);
		}
        loadImage("lamplightingafter");
        loadImage("lampwithoutstick");

		

        // fill in each note of the close-up xylophone
        noteRow[0] = new Note(0,"cNote", 17, 334, 175,
            688, context);
        noteRow[1] = new Note(1,"dNote", 184, 359, 332,
            683, context);
        noteRow[2] = new Note(2,"eNote", 336, 371, 472,
            673, context);
        noteRow[3] = new Note(3,"fNote", 473, 381, 607,
            673, context);
        noteRow[4] = new Note(4,"gNote", 615, 390, 742,
            673, context);
        noteRow[5] = new Note(5,"aNote", 746, 397, 868,
            665, context);
        noteRow[6] = new Note(6,"bNote", 873, 405, 989,
            665, context);
			
		

    }
    function changeScreen(screen){
		//clone canvas to get rid of previous events
		var clone = events.canvas.cloneNode();
		while (events.canvas.firstChild) {
		  clone.appendChild(events.canvas.lastChild);
		}
		events.canvas.parentNode.replaceChild(clone, events.canvas);
		//change screen and continue game
		if(screen==1 && !lampOn && currentScreen!=11){screen = 11}
		currentScreen = screen;
		continueGame();
	}
	function createEventBox(x,y,width,height,screen){
		//try setting stage here
		
		events.beginRegion();
		events.context.beginPath();
		events.context.rect(x, y, width, height);
		events.context.lineWidth = 4;
		events.context.strokeStyle = "black";
		events.context.fillStyle = "#00D2FF";
		events.context.fill();
		events.context.stroke();
		events.context.closePath();
		events.addRegionEventListener("mouseup",function(){
			//clear interval
			clearIn();
			changeScreen(screen);			
		});
		events.addRegionEventListener("mouseout", function () {
			document.body.style.cursor = "default";
			//console.log("mouseout");
		});
		events.addRegionEventListener("mousemove", function () {
			document.body.style.cursor = "pointer";
			//console.log("mouseover");
		});
		events.closeRegion();
		
	}
	function createEventShape(x,y,x1,y1,x2,y2,x3,y3,screen){
		//try setting stage here
		
			events.beginRegion();
			events.context.beginPath();
			events.context.lineWidth = 4;
			events.context.strokeStyle = "black";
			events.context.fillStyle = "#00D2FF";
			events.context.moveTo(x,y);
			events.context.lineTo(x1,y1);
			events.context.lineTo(x2,y2);
			events.context.lineTo(x3,y3);
			events.context.closePath();		
			events.context.fill();
			events.context.stroke();
			events.addRegionEventListener("mouseup",function(){
				//clear interval
				console.log(screen);
				console.log(lampOn);
				clearIn();				
				changeScreen(screen);
				
			});
			events.addRegionEventListener("mouseout", function () {
					document.body.style.cursor = "default";
			});
			events.addRegionEventListener("mousemove", function () {
					document.body.style.cursor = "pointer";
			});
			events.closeRegion();
			
			
		
	}
	function checkregion(mouse){

	}
	function drawStick() {
		events.context.beginPath();
		events.context.arc(cursorX, cursorY, 30, 0, 2 * Math.PI, true);
		events.context.fillStyle = "#FF6A6A";
		events.context.strokeStyle = "#FF6A6A";
		events.context.lineWidth = 7;
		events.context.closePath();
		events.context.fill();

		events.context.beginPath();
		events.context.moveTo(cursorX + 15, cursorY + 15);
		events.context.lineTo(cursorX + 130, cursorY + 130);
		events.context.stroke();
		events.context.closePath();
	}
    // defining each note on the xylophone
    function Note(num, note, topLeftX, topLeftY, topRightX, bottomLeftY, context) {
        this.ctx = context;

        this.note = note;
		this.noteNum = num;
		this.noteAudio = AudioFX('audio/'+note,   { formats: ['wav'], pool: 100 });
		this.alpha = 0.0;

        //x and y coordinates of the outline of the key
        this.topLeftX = topLeftX;
        this.topLeftY = topLeftY;
        this.topRightX = topRightX;
        this.bottomLeftY = bottomLeftY;
		
        this.width = topRightX - topLeftX;
        this.height = bottomLeftY - topLeftY;
		this.drawBox = function(){
			
			this.alpha = this.alpha - .01;
			if(this.alpha>0){
				ctx = events.context;
				ctx.save();
				ctx.beginPath();
				ctx.rect(this.topLeftX, this.topLeftY, this.width, this.height);
				ctx.fillStyle = "rgba(255, 0, 0, " + this.alpha + ")";
				ctx.fill();
				ctx.closePath();				
				ctx.restore();
			}
			else{
				this.alpha = 0.0;
			}
		};
    }
    Note.prototype.playSelf = function() {
		this.alpha = 1.0;
		this.noteAudio.play();
		//update and check note input array
      	newNote(this.noteNum);        
    };
    Note.prototype.keyDidPlay = function(stickX, stickY) {
        if (stickX >= this.topLeftX && stickX <= this.topRightX
            && stickY >= this.topLeftY && stickY <= this.bottomLeftY) {
            return true;
        } else {
            return false;
        }
    };

	function continueGame() {

		events = new Events("canvasOne");

        if      (currentScreen == 0) {
			events.setStage(function () {
				this.clear();
				events.context.drawImage(images["SCREEN1"], 0, 0, events.canvas.width, events.canvas.height);
				createEventBox(270,430,460,222,11);
			});
        }
		else if (currentScreen == 1) {
			lampOn = true;
			var fireCount = 1;
			var fireplace = null;
			
			
			function livingLoop(){
				console.log("onloop");
				events.clear();
				
                events.context.drawImage(images["livingroom"], 0, 0, events.canvas.width, events.canvas.height);
                events.context.drawImage(images["puzzleboxwpieces"], 440, 370, 120, 120);
				
				if(hasWeapon){}


				events.context.drawImage(images["fire"+fireCount ], 170, 170, 200, 200);
				fireCount++;
				if(fireCount==4){
					fireCount=1;
				}
			}
			
			livingLoop();
			intervalLoop = setInterval(livingLoop,100); 



			events.setStage(function () {
				if(currentScreen==5){console.log("he did it");alert("guau");}

				createEventBox(0,0,100,50,0);
				createEventShape(880,0,1000,0,1000,360,880,260,6);
				if(!solvedXylo){
					createEventShape(7,520,229,385,265,416,77,590,5);
				}
				createEventShape(400,24,430,24,448,90,387,90,11);
				if(!puzzleComplete){
					createEventBox(400,380,220,120,2);
				}
			});
			

        }
		else if (currentScreen == 6) {

			events.setStage(function () {
				this.clear();
				events.context.drawImage(images["hallway"], 0, 0, events.canvas.width, events.canvas.height);
				createEventBox(0,0,100,50,0);
				createEventBox(0,450,430,250,1);
				createEventBox(670,40,200,550,7);
			});

        }
		else if (currentScreen == 7) {

			events.setStage(function () {
				this.clear();
				events.context.drawImage(images["closeddoor"], 0, 0, events.canvas.width, events.canvas.height);
				createEventBox(0,0,100,50,0);
				createEventBox(0,550,1000,150,6);
			});

        }
		else if (currentScreen == 5) {
			

			var canvas = document.getElementById("canvasOne");
            var canvasPos = getCanvasPosition(canvas);            
			var mousePos = events.getMousePos();
			
			
		
			events.setStage(function () {
				createEventBox(0,0,100,50,1);
				document.body.style.cursor = "none";	//no cursor	
				
			});
			
			//loop to draw xylophone
			
			function xyloLoop(){
				console.log("xyloloop");
				events.clear();
				
				events.context.drawImage(images["xylophone"], 0, 0, events.canvas.width, events.canvas.height);
				
				//check if there is a playing note to draw red box
				var i = 0;
				
				for(i=0;i<7;i++){
					noteRow[i].drawBox();
				}
				drawStick();
			}
			
			xyloLoop();
			
			intervalLoop = setInterval(xyloLoop,10); 
			

            canvas.addEventListener("mousemove", function(){
				mousePos = events.getMousePos();
                cursorX = mousePos.x ;
                cursorY = mousePos.y ;
				
			}, false);
            canvas.addEventListener("mousedown", function(){

                for (var i = 0; i < 7; i++) {
                    if (noteRow[i].keyDidPlay(cursorX, cursorY)) {
                        noteRow[i].playSelf();
						currentnote = i;
                    }
                }
			}, false);
			
            


            function getCanvasPosition(element) {
                var x = 0;
                var y = 0;

                while (element) {
                    x += (element.offsetLeft - element.scrollLeft + element.clientLeft);
                    y += (element.offsetTop - element.scrollTop + element.clientTop);
                    element = element.offsetParent;
                }
                return {
                    x: x,
                    y: y
                };
            }

            

            
        }
		else if (currentScreen == 2) {
			//puzzle
			var draggingRect = [false,false,false,false,false,false,false,false,false];
			var check = 0;
			var draggingRectOffsetX = [0,0,0,0,0,0,0,0,0];
			var draggingRectOffsetY = [0,0,0,0,0,0,0,0,0];
			var piecewidth = 69;
			var context = events.context;
			var pixlet = 10;//how many pixels we can be not correctly placed

			events.setStage(function () {
				var mousePos = this.getMousePos();
				for(i=0;i<9;i++){
					if (draggingRect[i]) {
						puzx[i] = mousePos.x - draggingRectOffsetX[i];
						puzy[i] = mousePos.y - draggingRectOffsetY[i];					
					}
				}

				

				//now check if they are correctly organized;
				for(i=0;i<9;i++){
					if(i==2||i==5){
						if((puzx[i]-(piecewidth*2)>puzx[i+1]-pixlet)&&(puzx[i]-(piecewidth*2)<puzx[i+1]+pixlet)){

							if((puzy[i] + piecewidth > puzy[i+1]-pixlet)&&(puzy[i] + piecewidth < puzy[i+1]+pixlet)){
								check++;
							}
						}
					}
					else if (i==8){
						check++;
					}
					else{
						if((puzx[i]+piecewidth>puzx[i+1]-pixlet)&&(puzx[i]+piecewidth<puzx[i+1]+pixlet)){
							if((puzy[i]  > puzy[i+1]-pixlet) && ( puzy[i] < puzy[i+1]+pixlet)){
								check++;
							}
						}
					}
				}
				//check if all of the pieces are correct
				if(check == 9){
					check = 0;					
					puzzleComplete = true;
					
				}
				else{
					check = 0;
				}

				this.clear();
				events.context.drawImage(images["table"], 0, 0, events.canvas.width, events.canvas.height);
				events.context.drawImage(images["puzzleopened"], 400, 90, 350, 350);
				createEventBox(0,0,100,50,0);

				

				for(i=0;i<9;i++){

					this.beginRegion();
					context.rect(puzx[i], puzy[i], piecewidth,piecewidth);
					this.addRegionEventListener("mousedown", function(){
						draggingRect[i] = true;
						var mousePos = events.getMousePos();
						draggingRectOffsetX[i] = mousePos.x - puzx[i];
						draggingRectOffsetY[i] = mousePos.y - puzy[i];
					});
					this.addRegionEventListener("mouseup", function(){
						draggingRect[i] = false;
						if(puzzleComplete){
							changeScreen(1);
						}
						
						
					});
					this.addRegionEventListener("mouseout", function () {
						document.body.style.cursor = "default";
					});
					this.addRegionEventListener("mouseover", function () {
						document.body.style.cursor = "pointer";
					});
					this.closeRegion();

					events.context.drawImage(images[i], puzx[i], puzy[i], piecewidth, piecewidth);

				}


			});

        }
		else if (currentScreen == 11){
			lampOn = false;
			var fireCount = 1;
			var fireplace = null;
			
			
			function living2Loop(){
				console.log("offloop");
				events.clear();
				

                if (hasStick) {
					events.context.drawImage(images["lampwithoutstick"], 0, 0, events.canvas.width, events.canvas.height);
					
				}
				else{
					events.context.drawImage(images["lamplightingafter"], 0, 0, events.canvas.width, events.canvas.height);
				}
				events.context.drawImage(images["puzzleboxwpiecesdark"], 440, 370, 120, 120);
                    
				if(hasWeapon){}


				events.context.drawImage(images["fire"+fireCount+"dark" ], 170, 170, 200, 200);
				fireCount++;
				if(fireCount==4){
					fireCount=1;
				}
			}
			
			living2Loop();
			
			intervalLoop = setInterval(living2Loop,100); 



			events.setStage(function () {

				createEventBox(0,0,100,50,0);
				createEventShape(880,0,1000,0,1000,360,880,260,6);
				if(!solvedXylo){
					createEventShape(7,520,229,385,265,416,77,590,5);
				}
				createEventShape(400,24,430,24,448,90,387,90,1);
				if(!puzzleComplete){
					createEventBox(400,380,220,120,2);
				}
				
			});
		}
	}


    // if they click on the bedroom door AFTER they are at the close up view (not if they are just inside the hallway still)
    function attemptUnlockUpCloseBedroomDoor(canvas,context) {
        if (hasBedroomKey && hasWeapon) {
                context.drawImage(images["opendoor"], 0, 0, canvas.width, canvas.height);

            // then play the video of beating the monster and getting the key
        } else if (hasBedroomKey && ! hasWeapon) {
            context.drawImage(images["monster"], 0, 0, canvas.width, canvas.height);

            // then play the video of getting killed by the monster

            // then take user to end screen
			context.drawImage(images["SCREENMONSTER"], 0, 0, canvas.width, canvas.height);


        } else {
            // play some kind of "locked door" sound, display text of "door is locked"
        }
    }


    window.onload = function() {
		events = new Events("canvasOne");

		init();


	}
</script>

</body>
</html>
